# Working Log

## 2023-03-31
使用Auto Encoder复现国债收益率曲线的均值回归策略，效果一般

## 2023-04-04
新project（雏形）：使用各种商品因子和宏观择时指标对商品期货指数进行预测

**展期收益**：换月收益。比方说，有八月的多头合约将到期，八月合约的价格是一手20000元，将八月合约平仓后购买九月合约，而九月合约价格是一手18000元，就每手获得2000元的展期收益。

CTA策略的特点：CTA策略大部分都是**趋势策略**，趋势策略的特点就是"**低胜率，高赔率**"，没有行情的时候震荡阴跌，行情一来就把之前的亏损弥补掉，然后还有盈余。由于CTA趋势策略同质性比较大，反应在产品净值曲线上就是阴跌下行一段时间，然后向上突突，行情过后，又阴跌下行，而后又向上突突，如此循环往复。

### 点子

用利率曲线预测通胀，进而预测实际利率

从库存周期等宏观经济角度预测商品期货指数

### 宏观指标含义

**DR007利率**指银行间存款类金融机构以利率债为质押的7天期回购利率
**GC007利率**指国债7天期回购利率
**公开市场操作货币净投放**：钱从央行流出的量

## 2023-04-06
早上：处理了一下宏观数据，把数据处理成了可以直接用于模型训练的格式，把所有数据合并为一个表；使用LightGBM尝试拟合中证商品期货指数，但是模型似乎无法在测试集上取得有效结果
下午：深入Auto Encoder项目，对loss, optimizer, activation function, epoch等逐一进行了检查，选择了较为合适的参数，在['2Y','5Y','7Y','10Y','15Y','20Y']的数据上效果不好，检查后发现7Y严重影响了模型的效果，去掉7Y，加入0S后还不错。

## 2023-04-07
How to split time series data into train, validation and test sets?

You should use a split based on time to avoid the look-ahead bias. Train/validation/test in this order by time.

The test set should be the most recent part of data. You need to simulate a situation in a production environment, where after training a model you evaluate data coming after the time of creation of the model. The random sampling you use for validation and training is therefore not good idea.

## 2023-04-11
与彭老师讨论了Auto-Encoder的课题细节，直接使用Auto-Encoder对当日发布的收益率曲线进行重构，重构后的曲线能够follow原始数据走向。但是这种做法的预测逻辑完全基于均值回归。一种修改方法是将label全部shift一天，原理上这就不再是Auto-Encoder了，而是一个简单的神经网络。但是神经网络能不能学到东西很难说，Auto-Encoder的输入输出都是当天数据，结构上显然是相关的，但是shift之后，输入是昨天的，输出是今天的，学习仅限于翌日预测，神经网络不一定能学到什么。

与盛老师讨论了库存因子预测商品指数择时的问题。思路是根据各商品的库存同比变化指标先做成各商品各自的信号，然后将信号（等权）合成为一个因子，回测商品指数。
## 2023-04-12
修改了国债收益率Auto-Encoder模型进行翌日预测，确实预测不出来什么东西。

配置ECS云服务器，初步接触vim的用法

对汇率与商品指数之间的关系进行了回测，当期汇率变化和商品指数之间有较强的相关性，当人民币走强时，商品指数下跌，这是因为人民币走强，商品的价值没有变化，那么用同样多的人民币能够买到更多的海外商品，导致进口增多，国内的商品变多，价格下降；或者更直接地，商品价值不变，人民币升值，人民币定价地价格下降。

shift之后，翌日收益率不再具有相关性。但是如果考虑一段历史窗口期的累计收益，能够呈现一定的负相关性，大致考虑前一个月是最佳的时间窗口。

## 2023-04-13
重新跑了国债的东西，确实没有翌日预测效果。

接下来的工作方向是：直接使用回归模型（比如Lasso回归）进行预测，使用的变量除了水平斜率凸度，还加入动量因子，比如前一天的收益率，前一周的收益率，前一月的收益率等等。

商品指数方面，将把因子转换成策略，策略信号目前考虑以下几种做法：
1. 看正负，若窗口期收益率为正，做空，信号-1，反之信号为1
2. 看值，以窗口期收益率的相反数的一百倍直接作为信号
3. 看值，但设置阈值，因为过大的历史增幅可能导致回调

回测结果：信号正负的做法，时间窗口进一步调整，5天比较适合，但无论怎么调，2021-2022表现都不好，大概是输入型通胀所致。

## 2023-04-14
在各期限上，使用翌日收益率相对今天的bp变化作为label，使用多窗口的动量和水平斜率凸度因子作为自变量，使用Lasso等回归方式进行拟合，效果不好。故直接预测交易信号，即正负，将回归转换为分类问题。用RidgeClassifier，效果还不错。

一般来说CTA的做法是strategy-driven的，我们的模型从训练到测试都以策略信号为导向，label直接使用策略信号，回测也落实到策略上，查看pnl的收益

## 2023-04-18
国债期货代码
| 期限 | 代码 |
| :---: | :---: |
| 2Y | TS |
| 5Y | TF |
| 10Y | T |

将回测落实到期货上，发现效果不好，后来查出时间没对齐

## 2023-04-19
将时间问题反馈给彭老师并重新拼合数据，给彭老师备份

用新数据成功复现静态训练的结果，但是发现当训练集划分参数变化时，表现不好，说明这个做法不稳健。

同样，修改滚动训练的参数，表现会有比较大的变化，说明这个做法也不稳健。

加30年期

## 2023-04-20
和盛老师讨论商品指数择时。商品指数择时本质上就是预测通货膨胀。通胀影响利率，利率影响汇率，汇率影响国际贸易等，进而反作用于通胀。同种货币的利差本质上又可以反映通胀预期。

## 2023-04-21
根据中金所公布的各期限国债期货2023年6月合约的可交割券计算，2年期国债期货可交割券修正久期分布在1.64~2.25之间，平均值1.9。5年期国债期货可交割券修正久期分布在3.94~4.54之间，平均值4.25。10年期国债期货可交割券修正久期分布在6.22~8.51，平均值7.3。预估30年期国债期货可交割券修正久期分布在16.23~18.83之间，平均值17.5。
用表格表示：
| 期限 | 修正久期区间 | 修正久期均值 |
| :---: | :---: | :---: |
| 2Y | 1.64~2.25 | 1.9 |
| 5Y | 3.94~4.54 | 4.25 |
| 10Y | 6.22~8.51 | 7.3 |
| 30Y | 16.23~18.83 | 17.5 |

尝试使用基于斜率凸度并结合久期对冲的持仓策略，发现负持仓效果就是不好。提升的技巧有两个，一个是斜率凸度可以用非线性变换$f(\cdot)=\ln (1+\cdot)$，不过这种方法对于不同期限的提升不稳健，有可能是数据迁就。还有一种提升方法就是所有期限的动量一起训练，而不是之前的按不同期限计算动量。这样对不同期限都有提升，2016-2022收益可从20%提升到30%。

## 2023-04-25
### 债基因子研报思路梳理

**我大概了梳理一下文章逻辑：债基久期变动对国债期货有预测性，但是债基的久期数据是没有的，所以需要通过其他的手段算出债基的久期。在国债上计算发现NSS中shift的因子暴露度和久期相近，而shift因子暴露度可以只通过国债期限结构和净值来回归计算，所以能够算出债基的久期，进而预测国债期货**


PART 1: 使用中债收益率曲线，放到NSS模型中得到每天的shift, twist, butterfly
$$y_t(\tau)=\beta_{1t}+\beta_{2t}\left(\frac{1-\exp(\lambda_t \tau)}{\lambda_t \tau}\right)+\beta_{3t}\left(\frac{1-\exp(\lambda_t \tau)}{\lambda_t \tau}-\exp(\lambda_t \tau)\right)$$

每天（每个$t$）代入各期限$\tau_i$的收益率$y_t(\tau_i)$, 反算$\beta_{1t},\beta_{2t},\beta_{3t}$，至此得到时间序列$\boldsymbol{\beta}_j=\{\beta_{jt}\}_t$

计算因子暴露

对于某个债券，比如一年期国债，有一个债券价格计算公式$P(\tau)=DCF(r_\tau,\tau)$, 则该债券在因子$\beta$上的暴露度为
$$X=X(t,\tau)=-\frac{1}{P(\tau)}\frac{P_{up}-P_{down}}{50\textrm{bp}}$$

这是有公式的情况，对于债基，没有已知久期和公式，因子暴露度直接通过线性回归系数来算

PART 2: 使用不同品种进行回归（<b>线性回归</b>）
自变量：每天的shift, twist, butterfly因子值
因变量：各品种的债券价格

得到shift的因子暴露，作为债基久期的估计值

PART 3: 预测

## 2023-04-26

数据

根据万得数据，纯债基金有3000多支。纯债基金的净值曲线每周发布，需要赋权。




